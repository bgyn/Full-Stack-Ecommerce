<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("./partials/head.ejs") %>
    <title>Manage Products</title>
    <style>
      /* Ensure main content does not overlap */
      .main-content {
        margin-left: 250px; /* Push content to the right */
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Navigation -->
    <%- include("./partials/nav.ejs") %>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container-fluid mt-4">
        <h1>Manage Products</h1>
        <h3>Add New Product</h3>
        <form id="addProductForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="name" class="form-label">Product Name</label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-control"
              required
            />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea
              id="description"
              name="description"
              class="form-control"
              required
            ></textarea>
          </div>

          <h4>Product Variants</h4>
          <div id="variants-container"></div>
          <button
            type="button"
            class="btn btn-primary mb-3"
            onclick="addVariant()"
          >
            Add Variant
          </button>
          <button type="submit" class="btn btn-success">Add Product</button>
        </form>
      </div>
    </div>

    <script>
      function addVariant() {
        const variantContainer = document.getElementById("variants-container");
        const index = document.querySelectorAll(".variant-container").length;

        const variantHTML = `
          <div class="variant-container border p-3 mb-3">
            <h5>Variant ${index + 1}</h5>
            <button type="button" class="btn btn-danger btn-sm float-end" onclick="removeVariant(this)">Remove Variant</button>
            <div class="mb-2">
              <label>Price</label>
              <input type="number" name="variants[${index}][price]" class="form-control" required />
            </div>
            <div class="mb-2">
              <label>Color</label>
              <input type="text" name="variants[${index}][color]" class="form-control" required />
            </div>
            <div class="mb-2">
              <label>Size</label>
              <input type="text" name="variants[${index}][size]" class="form-control" required />
            </div>
            <div class="mb-2">
              <label>Stock</label>
              <input type="number" name="variants[${index}][stock]" class="form-control" required />
            </div>
            <div class="mb-2">
              <label>SKU</label>
              <input type="text" name="variants[${index}][sku]" class="form-control" required />
            </div>
            <h6>Images</h6>
            <div id="images-container-${index}"></div>
            <button type="button" class="btn btn-secondary" onclick="addImage(${index})">Add Image</button>
          </div>
        `;

        variantContainer.innerHTML += variantHTML;
      }

      function removeVariant(button) {
        const variantContainer = button.closest(".variant-container");
        if (variantContainer) {
          variantContainer.remove();
        }
      }

      function addImage(variantIndex) {
        const imageContainer = document.getElementById(
          `images-container-${variantIndex}`
        );
        const imageIndex = document.querySelectorAll(
          `#images-container-${variantIndex} .image-field`
        ).length;

        const imageHTML = `
          <div class="image-field mt-2">
            <button type="button" class="btn btn-danger btn-sm float-end" onclick="removeImage(this)">Remove Image</button>
            <label>Image File</label>
            <input type="file" name="variants[${variantIndex}][images][${imageIndex}][image]" class="form-control" accept="image/*" required />
            <label>Is Primary?</label>
            <select name="variants[${variantIndex}][images][${imageIndex}][isPrimary]" class="form-control">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        `;

        imageContainer.innerHTML += imageHTML;
      }

      function removeImage(button) {
        const imageField = button.closest(".image-field");
        if (imageField) {
          imageField.remove();
        }
      }

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const formData = new FormData(this);

          formData.append("name", document.getElementById("name").value);
          formData.append(
            "description",
            document.getElementById("description").value
          );

          document
            .querySelectorAll(".variant-container")
            .forEach((variantElem, i) => {
              formData.append(
                `variants[${i}][price]`,
                variantElem.querySelector('input[name="variants[${i}][price]"]')
                  .value
              );
              formData.append(
                `variants[${i}][color]`,
                variantElem.querySelector('input[name="variants[${i}][color]"]')
                  .value
              );
              formData.append(
                `variants[${i}][size]`,
                variantElem.querySelector('input[name="variants[${i}][size]"]')
                  .value
              );
              formData.append(
                `variants[${i}][stock]`,
                variantElem.querySelector('input[name="variants[${i}][stock]"]')
                  .value
              );
              formData.append(
                `variants[${i}][sku]`,
                variantElem.querySelector('input[name="variants[${i}][sku]"]')
                  .value
              );

              document
                .querySelectorAll(`#images-container-${i} .image-field`)
                .forEach((imageElem, j) => {
                  const fileInput =
                    imageElem.querySelector('input[type="file"]');
                  if (fileInput.files.length > 0) {
                    formData.append(
                      `variants[${i}][images][${j}][image]`,
                      fileInput.files[0]
                    );
                  }
                  formData.append(
                    `variants[${i}][images][${j}][isPrimary]`,
                    imageElem.querySelector("select").value
                  );
                });
            });

          const response = await fetch("/products/add", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          if (response.ok) {
            alert("Product added successfully!");
            window.location.reload();
          } else {
            alert(data.message || "Failed to add product");
          }
        });
    </script>

    <%- include("./partials/script.ejs") %>
  </body>
</html>
